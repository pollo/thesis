\documentclass[12pt,a4paper,twoside]{book}
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage[font=small,labelfont=bf]{caption}
\usepackage{subcaption}
\usepackage{amsmath}
\usepackage{hyperref}

\makeatletter
\newcommand\ackname{Acknowledgements}
\if@titlepage
  \newenvironment{acknowledgements}{%
      \titlepage
      \null\vfil
      \@beginparpenalty\@lowpenalty
      \begin{center}%
        \bfseries \ackname
        \@endparpenalty\@M
      \end{center}}%
     {\par\vfil\null\endtitlepage}
\else
  \newenvironment{acknowledgements}{%
      \if@twocolumn
        \section*{\abstractname}%
      \else
        \small
        \begin{center}%
          {\bfseries \ackname\vspace{-.5em}\vspace{\z@}}%
        \end{center}%
        \quotation
      \fi}
      {\if@twocolumn\else\endquotation\fi}
\fi
\makeatother

\newcommand{\norm}[1]{\lVert#1\rVert}
\newcommand{\degree}{\ensuremath{^\circ}}

\bibliographystyle{abbrv}
\begin{document}

\begin{titlepage}
  \begin{center}
    \begin{Large}University of Trento\\\end{Large}
     Departement of Information Engineering and Computer Science  \\
     \vspace{10pt}
     \begin{figure}[htbp]
       \begin{center}
         \includegraphics[width=3cm]{images/unitn.eps}
       \end{center}
     \end{figure}
Degree Course in Computer Science\\

\vspace{10pt}
\line(1,0){338}
\vspace{10pt}

Final Thesis\\
\end{center}
\vspace{3cm}
\begin{center}
\begin{Large}An open-source implementation of a particle-based model for skiing dynamics\\\end{Large}
\vspace{3cm}
\end{center}
Supervisor: \\ \textbf{Prof. Alberto Montresor} \\
Co-supervisor:\hspace{8.15cm}Graduant:   \\
\textbf{Dr. Cesare Furlanello}\hspace{6.3cm}\textbf{Matteo Poletti}
\vspace{1cm}
\begin{center}
Accademic Year 2012-2013
\end{center}
\end{titlepage}

\chapter*{Summary}
The goal of this thesis work is to implement a computational model of skiers at high spatial resolution based on the agent-based approach. The model simulates the trajectories of skiers descending a ski slope, enabling different applications of interest for skiing safety analysis as well as skiers behavior profiling. In particular the first applicative goal of this thesis is to contribute to a general predictive model for skiing accidents prevention by providing estimates of traffic indicators along the ski slopes. Specifically, the computational model aims to provide average speed and density of skiers.

The thesis work was developed within the context of the SicurSkiWeb project, which is a new project of the Bruno Kessler Foundation in collaboration with the Polizia di Stato and the Association of skiing resorts of Trentino. SicurSkiWeb offers a GeoICT management platform collecting all data about rescue interventions by ski patrols, with the goal of providing a predictive platform to increase safe skiing.

The model implemented is a particle-based model proposed by Holleczek and Troster \cite{hol2012}. Skiers are modeled as particles with a mass subjected to physical and social forces, which define their riding behavior during the descents on ski slopes. Physical forces determine the acceleration of skiers. Social forces are used to individuate the skiers desired direction, namely the direction in which a skier is inclined to travel, that is used to decide whether skiers need to adjust their direction performing a turn. The model presented by Holleczek and Troster was limited to experienced skiers only. The major change introduced in this thesis is the modeling of other classes of skiers, such as beginners and intermediates. A second group of changes is related to the implementation of the social forces: skier choices related to their trajectories were made dynamically depend on the position and velocity of the skiers and on the condition of the slope, such as the shape of the trail and the terrain slope.

An adaptation of the model was additionally realized in order to simulate ski lessons. In these patterns, agents have strongly correlated trajectories: the first agent simulates the instructor and decides the trajectory autonomously, the following agents are forced to emulate the instructor trajectory.

The implementation was realized in C++ using the GRASS GIS C-API for the spatial computations. GRASS GIS is an Open Source Geographic Information System (GIS) software used for geospatial data management and analysis. A new GRASS module has been developed. An analysis of the code performances suggested optimizing the implementation with caching mechanisms that reduce the global computation time.

The model has been tested by using a set of real data collected in February and March 2013. The mobile application SkiLogger, developed within the SicurSkiWeb project, was used to collect data of real skiers. SkiLogger can be used by skiers to track their trajectories by GPS sensors, now usually available also on common smartphones. The application allowed to track a total of 171 Km of descents on ski slopes by 18 distinct skiers. An initial calibration of the model was based on the SkiLogger dataset. A comparison between real data and simulated data was performed in terms of speed values. The average error for the considered tracks ranges between 4.28m/s and 6.44m/s, while recorded speeds range from 0 to 30m/s. The model was then modified to include possible stops along the ski slope. A new experimental stop parameter was introduced, obtaining a $55\%$ reduction of the average error made for a specific track. Figure \ref{speeds} shows the recorded speeds of a track on the ski slope ``Uno di Tognola'' of San Martino di Castrozza in Trentino (Italy) and compares them to the speeds predicted by the simulation.

\begin{figure}[!h]
        \centering
        \begin{subfigure}[b]{0.5\textwidth}
                \centering
                \includegraphics[width=\textwidth]{images/sm_track116.eps}
        \end{subfigure}%
        ~ %add desired spacing between images, e. g. ~, \quad, \qquad etc.
          %(or a blank line to force the subfigure onto a new line)
        \begin{subfigure}[b]{0.5\textwidth}
                \centering
                \includegraphics[width=\textwidth]{images/sm_stops_track116.eps}
        \end{subfigure}
        \caption{Comparison between speed values recorded for a track and average simulated speeds. Figure on the left shows simulated speed values without stops. Figure on the right shows speed values with forced stops.}\label{speeds}
\end{figure}

Chapter \ref{model} describes the model and defines the physical and social forces. Chapter \ref{implementation} presents the technologies employed and gives details related to the model implementation and the parameters selection. Chapter \ref{steps_validate} presents the data collected and the comparisons with the simulated data. A summary of results and a concluding remark are given in Chapter \ref{conclusions}.

\begin{acknowledgements}
This thesis work was developed in the MPBA unit of the Bruno Kessler Foundation. I would like to thank Prof. Alberto Montresor, who has supervised me during this work. This thesis would not have been possible without the help and support of all the MPBA unit, in particular I would like to thank Cesare Furlanello, for having guided and advised me during this period, and Riccardo De Filippi, who helped me in writing the thesis. A big thank goes to Andrea Gobbi, for his patience, his competence and for the many useful discussions we had during these months. I would like to thank also Prof. Nicola Pugno, for his suggestions concerning the physical model. Finally, I thank my family for supporting me throughout all my studies.
\end{acknowledgements}

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Introduction}
Alpine skiing is a winter sport widely practiced in the Alps and it is a key resource for the tourism sector. Each year more than 80.000.000 single ski lifts passages are counted in Trentino's ski resorts where the ski accidents risk ratio on single passages is about 1:10.000.

SicurSkiWeb is a project of the Bruno Kessler Foundation and Polizia di Stato aiming to monitor and improve safety on ski slopes, in collaboration with the Trentino Skiing Resorts Managers Association and the Trentino Ski Instructor Association. The main output of the project is a GeoICT platform for the collection and the analysis of all data collected during the rescue interventions by ski patrols. Up to today the platform geodatabase includes records for 2571 interventions: the 70\% of accidents involves skiers while 20\% are snowboarders; moreover 80\% of the interventions are due to accidental causes while 11\% are caused for collisions with other persons, and 4\% are due to illnesses.

The GeoITC infrastructure is composed of three modules:
\begin{enumerate}
\item An Android application for data collection synchronized with the main platform geodatabase.
\item A WebGIS platform to manage or visualize field data and to constantly monitor the evolution of the risk on the slopes.
\item A set of analysis tools for understanding, studying and mapping the risk of accidents and its relationship with environmental and social factors.
\end{enumerate}
This thesis work aims to provide an analysis framework to describe the behavior of skiers while performing their descents on ski slopes. The output of this analysis will be used as a useful component of the analysis module of the SicurSkiWeb platform, in particular for speed and traffic density estimates.

Traffic simulations have been widely used to predict motions of objects such as vehicles and pedestrians using models from statistical physic. Holleczek and Troster proposed this methodology to predict skiing traffic. Following their approach, skiing dynamics has been simulated using a particle-based model.

The problem faced in this thesis work involves patterns that can be recognize also modeling other kind of systems. In sports, the behavior of a player is influenced and determined by the other players actions, by their distribution on the field and by the phase of the game. The players behaviors depends also on their role and their interpretation of the game. Dynamics of the players on the field has already been investigated for sports as basketball \cite{bo2010}, tennis \cite{pa2005} and squash \cite{mc2006}. For team sports and specifically rugby, a model of interpersonal dynamics in terms of multiagent system was proposed \cite{qu2009}. Multiagent system are often simulated also in videogames. However, this kind of simulations do not aim to simulate real agents but try to reproduce credible scenarios allowing to use heuristics and predetermined sets of rules derived by specific knowledge of the domain. Nevertheless, the physics implemented by skiing simulator videogames is closely related to the one implemented in this thesis.

Empirical data plays a key role modeling this kind of system: they are essential to calibrate the model parameters and to investigate the agents behavior. In the collection of data, wearable sensors offer important possibilities for the capturing of motions. Pressure sensors and gyroscope were already successfully employed to track snowboarders activities \cite{hol2010}, a similar workflow can be followed for skiers.

\chapter{The model}\label{model}
The model implemented in this thesis can be classified as a two-dimensional microscopic-driven many-particle system with the constraint that skiers are exposed to gravity and centripetal forces. It was published by Holleczek and Troster \cite{hol2012}.

Skiers are modeled as particles with a specific mass, $m$, that are exposed to two class of forces:\begin{enumerate}
\item Social forces, that determine skiers behavior.
\item Physical forces, that regulate the skier motion determining the acceleration.
\end{enumerate}
In the following, the position of a skier at time $t$ is represented by the vector $r(t)$, $\dot{r}(t)=\frac{d}{dt}r(t)$ is the vector speed, and $e_{\dot{r}}(t)=\ \dot{r}(t) / \Vert \dot{r}(t)\Vert$ the direction of motion.

\section{Social forces}
The social forces implemented in the model describe the decisions taken by a skier while descending a slope. Social forces are dimensionless and are used to determine whether the skier should take a turn or not, however they do not act on acceleration. The superposition of all social forces, $F_{social}$, gives skier's desired direction $e_{social}(t)=F_{social} / \Vert F_{social} \Vert$. If the desired direction $e_{social}(t)$ diverges from the actual skier direction of motion $e_{\dot{r}}(t)$ more than an angle ${\delta}$, the skier starts to turn adjusting the direction (see Fig.\ref{start_turn_pic}). Social forces are used to model the repulsion of the skier from slope edges, potential obstacles and from other skiers and to attract skiers towards the chosen destination. The repulsion from obstacles can be thought as the repulsion from physical obstacles, such as snow guns or piles of ski lifts, but also as the repulsion from areas of the ski slope perceived as dangerous, such as sheets of ice.

\begin{figure}
  \begin{center}
    \includegraphics[width=0.5\textwidth]{images/start_turn_pic.eps}
    \caption{(From \cite{hol2012}) When the angle between the current direction of motion $e_{\dot{r}}$ and the desired direction $e_{social}$ is bigger than $\delta$ the skier performs a turn to adjust his or her direction.}\label{start_turn_pic}
  \end{center}
\end{figure}

To describe the social force that attracts the skier towards the chosen destination, the model assumes that each skier, while descending, selects several waypoints $x_a^1....x_a^n$ as temporary destinations. Thus, at each time $t$ the skier $a$ wants to reach a waypoint $x_a(t)=x_a^k$ for some $k$. The direction toward the current waypoint is expressed by

\begin{equation}\label{waypoint_direction}
e_a(t)=\frac{x^k_a-r_a(t)}{\Vert x^k_a-r_a(t) \Vert},
\end{equation}
where, as defined above, $r_a(t)$ is the position of $a$ at time $t$ (for the sake of notation $r_a$). The destination social force drives the skier toward the waypoint and is defined as

\begin{equation}\label{destination_force}
F_D(r_a)=A_0 e_a(t),
\end{equation}
where $A_0$ is a scaling constant that represents the strength of the destination force.

The attitude of skiers to keep a minimum distance from the edges is modeled with repulsion forces that are stronger when the skier gets closer to the edge of the slope. At each position $r_a$ the skier $a$ is subjected to repulsion forces from the left and right edges of the slope. Let $r_a^L$ be the closest location to $r_a$ on the left edge, then the distance between the skier and the edge can be expressed as $r_{aL}=r_a-r_A^L$. The repulsion force from the left edge is defined as

\begin{equation}\label{left_force}
F_L(r_{aL})=-\nabla_{r_{aL}}U(\Vert r_{aL} \Vert ),
\end{equation}
where $U(\Vert r_{aL} \Vert )$ is a monotonically decreasing potential. In a symmetric way the repulsion force from the right edge can be defined as

\begin{equation}\label{right_force}
F_R(r_{aR})=-\nabla_{r_{aR}}U(\Vert r_{aR} \Vert ).
\end{equation}

The model takes into account also the natural human behavior of avoiding collisions with other skiers. This is described by a repulsion force, referred as skier repulsion force, that each skier imposes on the other skiers. The repulsion force that skier $b$ imposes on the skier $a$ can be expressed as

\begin{equation}\label{skier_force}
F_S(r_{ab})=-\nabla_{r_{ab}}V(s(r_{ab})),
\end{equation}
where $r_{ab}=r_a-r_b$ is the distance vector between the two skiers, $V(s(r_{ab}))$ is a monotonically decreasing potential with equipotential lines shaped as ellipses directed into the direction of motion and $s$ represents the semiminor axis of this ellipse and is defined as

\begin{equation}\label{skier_s}
s(r_{ab})=\frac{\sqrt{(\Vert r_{ab} \Vert + \Vert r_{ab}-v_b \Delta t e_b \Vert )^2-(v_b \Delta t)^2}}{2}.
\end{equation}

Finally a repulsion force from the obstacles on the slope is considered. The force that an obstacle $o$ imposes on the skier $a$ is defined as

\begin{equation}\label{obstacle_force}
F_O(r_{ao})=-\nabla_{r_{ao}}W(\Vert r_{ao} \Vert ).
\end{equation}

In general, repulsion social forces act on skiers only if they are capable of perceiving what triggers the force. The model assumes that objects are perceived only within a certain range $\varphi$ of the skier direction. $2\varphi$ can be considered as the angle of view. This is modeled by the weight

\begin{equation}\label{visibility}
w(u,v)=\begin{cases}
  1 & \text{if $(u/\Vert u \Vert)\cdot (v/\Vert v \Vert) \geq \cos \varphi$} \\
  0 & \text{otherwise }
  \end{cases}
\end{equation}

To summarize, social forces actiong on every skier $a$ are
\begin{align}\label{social_forces_tb}
F_D(r_a)&=A_0 e_a(t),\\
F_L(\dot{r_a},r_{aL})&=w(\dot{r_a},-r_{aL})F_L(r_{aL}),\\
F_R(\dot{r_a},r_{aR})&=w(\dot{r_a},-r_{aR})F_R(r_{aR}),\\
F_A(\dot{r_a},r_{ab})&=w(\dot{r_a},-r_{ab})F_A(r_{ab}),\\
F_O(\dot{r_a},r_{ao})&=w(\dot{r_a},-r_{ao})F_O(r_{ao}).
\end{align}

The resultant social force $F^a_{social}$ is the superposition of all social forces that apply on skier $a$:

\begin{equation}
F^a_{social}=F_D(r_a)+F_L(\dot{r_a},r_{aL})+F_R(\dot{r_a},r_{aR})+\sum_{b\in S} F_A(\dot{r_a},r_{ab})+\sum_{o \in O} F_O(\dot{r_a},r_{ao}),\nonumber
\end{equation}
where $S$ is the set of skiers and $O$ the set of obstacles in the current time frame and visibility. Figure \ref{social_forces_diagram} shows a diagram of the social forces described above.

\begin{figure}
  \begin{center}
    \includegraphics[width=0.7\textwidth]{images/social_forces_dia.eps}
    \caption{(From \cite{hol2012}) Diagram of the social forces. The forces $F_R$ and $F_L$ keep the skier $a$ away from the edges, the force $F_O$ repels the skier from the obstacle, the force $F_A$ repels $a$ from the skier $b$ and the force $F_D$ attracts the skier towards the waypoint. The vector $e_{\dot{r}}$ is the direction of motion.}\label{social_forces_diagram}
  \end{center}
\end{figure}


\section{Physical forces}
As described in \cite{hol2012}, there are two major techniques used to curve while skiing: \textit{skidding} and \textit{carving}. When carving, the direction of motion is exclusively parallel to the skis while in skidding there is an additional slippage to the side. Carved turns are usually performed by expert skiers, while beginners and non-experienced skiers tend to perform skidded turns.

In \cite{hol2012} skiers are supposed to perform turns with a radius corresponding to the \textit{sidecut radius} of their skis. Although some studies \cite{jen2004} \cite{fe2010} have proposed a more realistic model of carving turns, deeply investigating the effects of ski penetration in the snow and of the skier tilt angle, as a first version of the model the approximation of the turning radius to the sidecut radius was considered acceptable. Figure \ref{sidecut_radius} shows the relation between sidecut radius and turning radius.

\begin{figure}
  \begin{center}
    \includegraphics[width=0.8\textwidth]{images/sidecut_radius.eps}
    \caption{(From \cite{hol2012}) Profile of a carving ski with the sidecut radius $R_{SC}$ evidenced.}\label{sidecut_radius}
  \end{center}
\end{figure}

Gravitational, centripetal and friction forces determine the skiers acceleration according to their direction $e_{\dot{r}}$. Consider a skier at position $r$ with speed $\dot{r}$ and direction of motion $e_{\dot{r}}$ and let $n$ denote the surface normal on the ski slope at $r$. At $r$, the ski slope has an inclination angle of
\begin{equation}
\alpha =\arccos(\left[0,0,1\right] \cdot n)
\end{equation}
and the inclination angle $\gamma$ of the current trajectory $e_{\dot{r}}$ is
\begin{equation}\label{incl_angle}
\gamma =\arcsin[(\sin \alpha )(\sin \beta )],
\end{equation}
where $\beta$ is the angle between $e_{\dot{r}}$ and the horizontal of the slope.

To compute the force accelerating the skier the gravitational force, the friction forces and the centripetal forces should be investigated. As first the gravitational force $F_G$ is considered. It can be expressed as
\begin{equation}
F_G=mg\left[\begin{matrix}0\\0\\-1\end{matrix}\right],
\end{equation}
where $g$ is the gravitational acceleration and $m$ the mass of the skier. The gravitational force can be subdivided into normal force $F_N$, acting parallel to the surface normal $n$, and into downhill force $F_S$, acting parallel to the fall line.
\begin{equation}\label{downhill_force}
F_G=F_S-F_N.
\end{equation}
The normal force $F_N$ can be expressed as
\begin{equation}
F_N=mg(\cos \alpha )n.
\end{equation}

The downhill force $F_S$ itself can be subdivided into $F_P$ which is acting parallel to the current trajectory $e_{\dot{r}}$ and into the lateral force $F_{lat}$ acting perpendicularly to the current trajectory (see Fig.\ref{downhill_force_pic}).

\begin{equation}
F_S=F_P+F_{lat}.
\end{equation}
\begin{figure}
  \begin{center}
    \includegraphics[width=0.5\textwidth]{images/figure5.eps}
    \caption{(From \cite{hol2012}) The downhill force $F_S$ can be decomposed into the downhill force $F_P$, acting parallel to the current trajectory, and into the lateral force $F_{lat}$ acting perpendicularly to the direction of travel.}\label{downhill_force_pic}
  \end{center}
\end{figure}

The downhill force $F_p$ can be written as
\begin{equation}
F_P=mg ( \sin \gamma ) e_{\dot{r}}=mg ( \sin \alpha ) ( \sin \beta ) e_{\dot{r}}.
\end{equation}
where $\gamma$ is the inclination angle of $e_{\dot{r}}$ defined as in \ref{incl_angle}.

Remembering \ref{downhill_force}, the downhill force $F_S$ can be computed as
\begin{equation}
F_S=F_G+F_N.
\end{equation}
The lateral force $F_{lat}$ can therefore be computed as
\begin{equation}
F_{lat}=F_S-F_P=F_G+F_N-F_P.
\end{equation}
The centripetal force $F_C$ a skier is exposed to while turning can be written as
\begin{equation}
F_C=\frac{m}{R_{SC}} {\norm{\dot{r}}}^2 \frac{F_{lat}}{\norm{F_{lat}}} \times
\begin{cases}
  (+1) & \text{before crossing the fall line} \\
  (-1) & \text{after crossing the fall line}
  \end{cases},
\end{equation}
where $m$ is the mass of the skier and $R_{SC}$ the sidecut radius of the skis. The force $F_C$ is parallel to $F_{lat}$ before the skier crosses the fall line and antiparallel to $F_{lat}$ after having crossed the fall line.

Before defining the kinetic friction of skis on snow, a definition of effective force should be given. The effective force is the force that needs to be compensated by the snow. Its formulation depends on whether the skier is performing a turn or is descending on a straight line. In the following, when the definition of a force changes depending on whether the skier is turning, the index is written lowercase in the case of a straight line and uppercase in the case of a turn. So $F_{eff}$ is the effective force acting on a skier that is descending on a straight line and is defined as
\begin{equation}
F_{eff}=F_{lat}-F_N.
\end{equation}
If the skier is performing a carved turn then the effective force $F_{EFF}$ can be written as
\begin{equation}
F_{EFF}=F_{lat}-F_C-F_N.
\end{equation}
Figure \ref{effective_force_pic} shows the effective force ($F_{eff}$ and $F_{EFF}$).

\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{images/figure6.eps}
    \caption{(From \cite{hol2012}) In (a) effective force during the descent on a straight line ($F_{eff}=F_{lat}-F_N$). In (b) effective force during a carved turn ($F_{EFF}=F_{lat}-F_N-F_C$).}\label{effective_force_pic}
  \end{center}
\end{figure}

The kinetic friction force $F_{ground}$ can be expressed in terms of the skier's effective force as

\begin{equation}
F_{ground}=-\mu \norm{F_{eff}}e_{\dot{r}},
\end{equation}
when descending on a straight line. The parameter $\mu$ is the kinetic friction coefficient of the skis on the snow. In case of a turn

\begin{equation}
F_{GROUND}=-\mu \norm{F_{EFF}}e_{\dot{r}}.
\end{equation}

The air drag force $F_{air}$ is antiparallel to the direction of motion $e_{\dot{r}}$ and is defined as

\begin{equation}
F_{air}=-\frac{1}{2}C_d \rho A \norm{\dot{r}}^2 e_{\dot{r}},
\end{equation}
where $C_d$ is the drag coefficient, $\rho$ the air density and $A$ the projected frontal area of the skier perpendicular to the direction of motion.

Finally, the net force $F_{net}$ accelerating the skier can be defined as

\begin{equation}\label{physical_resultant_nt}
F_{net}=F_P + F_{air} + F_{ground},
\end{equation}
if the skier is not turning. Otherwise the force is defined as

\begin{equation}\label{physical_resultant}
F_{NET}=F_P + F_{AIR} + F_{GROUND} + F_C.
\end{equation}

\section{Limitations}
The model proposed describes the motion of an expert skier that skies performing perfect carved turns and the turning radio is taken constant and equals to the sidecut radius of the skis. Non-experienced skiers and other snow-sport athletes are not considered. An important limitation of the model is that it does not consider that skiers could stop while descending a slope. Moreover skiers are not allowed neither to jump nor to exit the ski slope: if skiers collide with an edge of the slope they are reflected back with an angle equals to the angle at which they have collided.

\section{Innovation from the original model}
\subsection{Extension 1}
The main extension introduced in the new implemented model was modeling also non-experienced skiers. Beginner and intermediate skiers perform skidded turns. In a skidded turn the direction of motion is parallel to the skis, however there is an additional component of the motion directed to the side of the turn due to a slippage of the skis on the snow. This results in a significant loss in speed due to the ``plowing'' action of the skis on the snow which generates a high frictional resistance. To simulate skidded turns, only a fraction of the $F_P$ component of the gravitational force parallel to the direction of motion is considered to accelerate the skiers. In fact, a fraction of this force is loss in the slippage and does not produce a speed increase. Therefore, for non-experienced skiers the net force while turning (defined in \ref{physical_resultant}), $F_{NET}$, should be redefined as
\begin{equation}
F_{NET}=(1-\eta) F_P + F_{AIR} + F_{GROUND} + F_C,
\end{equation}
where $\eta$ takes value between 0 and 1 and is a coefficient describing the entity of the slippage in the turns. For expert skiers $\eta$ is set equal to 0. It should be noted that in the case a skier is not turning or stops the net force remains defined as in \ref{physical_resultant_nt}.

\subsection{Extension 2}
Other changes in the original model are related to the social forces. In particular, the destination force $F_D$ (defined by \ref{destination_force}) is of critical importance. The effectivness of this destination force is strongly related to the waypoints selection. In the original paper the waypoints were selected randomly every 50m, using a uniform distribution on the corresponding line from the left to the right edge of the slope (see Fig.\ref{waypoints_old_pic}).

\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{images/waypoint_line.eps}
    \caption{In \cite{hol2012} waypoints were selected randomly every 50m following a uniform distribution on the line from the left to the right edges of the slope.}\label{waypoints_old_pic}
  \end{center}
\end{figure}

A more dynamic approach in the waypoints selection has been considered to better model the decisions taken from a skier while descending a slope. The new strategy allows each skier to dynamically choose waypoints during the descent, based on the position of the skier, on the shape of the trail, on the slope of the terrain and on the skier speed.

Hereafter the new mechanism for the waypoints selection is explained (see Fig.\ref{new_waypoint_pic}). Let $a$ be a skier at position $r_a$, let $r_a^L$ be the location on the left slope edge closest to $r_a$ and $r_a^R$ the location on the right slope edge closest to $r$. The vectors given the directions toward the edges are $e_{aR}=\left(r_a^L-r_a\right)/\norm{r_a^L-r_a}$ and $e_{aL}=\left(r_a^R-r_a\right)/\norm{r_a^R-r_a}$. Let $\alpha$ be the angle between $e_{aR}$ and $e_{aL}$ defined as

\begin{equation}
\alpha=\begin{cases}
  \arccos(e_{aR} \cdot e_{aL}) & \text{if } (e_{aR} \times e_{aL})\cdot n \ge 0 \\
  2\pi-\arccos(e_{aR} \cdot e_{aL}) & \text {if } (e_{aR} \times e_{aL})\cdot n < 0
\end{cases},
\end{equation}
where $n$ is the normal of the plane containing $e_{aR}$ and $e_{aL}$. The skier $a$ chooses the new waypoint with uniform distribution on a fraction of the angle $\alpha$. More precisely, let $p$ be the fraction of angle that should be considered, then the new waypoint $w_a$ is chosen as

\begin{equation}\label{new_waypoint}
w_a=r_a+\rho F\left(\frac{e_{aR}+e_{aL}}{\norm{e_{aR}+e_{aL}}},\mathcal{U}\left(-\frac{p \alpha}{2},\frac{p \alpha}{2}\right)\right),
\end{equation}
where $\rho$ is the distance at which waypoint are chosen, the function $F\left(v,\beta\right)$ rotates the vector $v$ of an angle $\beta$ and $\mathcal{U}(a,b)$ returns a random number with uniform distribution on $(a,b)$ (see Fig.\ref{new_waypoint_pic}).

\begin{figure}[!h]
  \begin{center}
    \includegraphics[width=0.8\textwidth]{images/waypoint_new.eps}
    \caption{Selection of waypoints: the skier $a$ selects the new waypoint $w$ choosing with uniform distribution on the angle $p\alpha$, a fraction of $\alpha$. The angle $\alpha$ is the angle between $e_{aR}$, the vector representing the direction towards the right edge, and $e_{aL}$, the vector towards the left edge.}\label{new_waypoint_pic}
  \end{center}
\end{figure}

A new waypoint is selected when the old waypoint is no longer feasible, meaning that it is not in the interval that the skier would consider when choosing a new waypoint, or when the skier has traveled more than $D$ meters after having chosen the last waypoint.

The new approach for waypoints selection considers closely skier speed and the effect of the slope shape on skier's action according to the following constraints:\begin{enumerate}
\item \label{depending_velocity} When skiers are faster they tend to turn more often to decrease the speed.
\item \label{frequency} Frequency of the selection of new waypoints should depend on the skiers speed, the more skiers are traveling fast, the more frequently they will choose new waypoints.
\item \label{depending_slope} The selection of a new waypoint should depend on the slope that the skiers will face in their range of action: approaching flat areas skiers tend to go straight to increase velocity.
\item \label{avoid_impact} Skiers usually avoid to choose a direction that would make them turn on the edge of the slope. Therefore, the new waypoint should be in a position that does not lead the skier to impact the edge of the slope.
\end{enumerate}

To model the influences of skier's speed and shape of the slope it is possible to act on the parameter $p$ of the equation \ref{new_waypoint}. When $p$ is increasing, the width of the angle in which new waypoints can be chosen becomes larger. As a consequence the probability of performing turns becomes higher.

Point \ref{depending_velocity} can be satisfied by making the parameter $p$ linearly depend on skier's speed $v$. Moreover it is required that when the speed $v$ is close to $0$ the width of the angle should be also close to $0$ and when $v$ is close to a high value of speed $v_{high}$ the angle should have maximum width. Therefore, $p$ can be set to
\begin{equation}\label{delta_vel}
p= \frac{v}{v_{high}}.
\end{equation}
$v_{high}$ is a speed value that is considered high for the skier modeled. Approaching this value the skier enlarges the possible angle of waypoints selection and is more likely to perform turns decreasing their speed.

The requirement \ref{frequency} is already met by the mechanism described above. In fact, since a new waypoint is chosen each time the skier has traveled more than $D$ meters, when skiers are faster they choose waypoints more frequently.

To fulfill the third requirement, an additional factor depending on the slope should be considered. Let $s$ be the slope that the skier is going to encounter and let $s_{lim}$ a value of slope that is considered small enough to require an additional acceleration by the skier. Then if $s<s_{lim}$ the width of the angle in which to choose the new waypoint should be narrowed again. Taking into account \ref{delta_vel} then we can write $p$ as

\begin{equation}
p=\begin{cases}
   \frac{v}{v_{high}}\frac{s}{s_{lim}} & \text{if } s < s_{lim} \\
   \frac{v}{v_{high}} & \text{otherwise}
\end{cases}.
\end{equation}
If, despite this, skiers will come to a complete stop (maybe due to a counter slope), they will start walking at constant speed.

Finally, to satisfy point \ref{avoid_impact} manipulating $p$ will not be enough. The minimum turning radius of skiers gives a bound to their ability of avoiding a collision or to hit the edges of the ski slope. Assuming that a skier does not choose a direction that will make them exit the ski slope, those angles indicating a direction along which the slope edge is reached in less than $R_{SC}$ meters are not considered in the selection of the waypoint.

\subsection{Other possible extensions}
The simulation can include a more advanced model of the obstacles repulsion. The repulsion from physical obstacles can be easily implemented when the GIS database will provide the information needed (e.g. the position of the piles of the ski lift). In addition to this, other kind of obstacles can be included in the model to represent areas of the slope considered dangerous by the skiers. For example obstacles can simulate sheets of ice (that can change position depending on the time of the day) or areas with high slope (depending on skiers' skill). This extension was not implemented in this thesis.

When skiing in groups it may be appropriate to make the skiers trajectories influencing each other. During ski lessons for example, skiers trajectories can be forced to emulate the instructor trajectory. This approach is investigated in more detail in section \ref{ski_lessons}.

\chapter{Implementation}\label{implementation}
The model was implemented using C++ and GRASS GIS. GRASS is a Geographic Information System (GIS) open-source software used for geospatial data management and analysis. It was chosen to perform the geospatial computations needed by the model.

\section{Technologies used}
Different technologies were explored and used to implement the GIS platform of the model. PostGIS, QGIS, GDAL/OGR and GRASS GIS were the main technologies considered.

PostGIS is an open-source spatial database extender for PostgreSQL database. It provides support for geographic objects manipulation allowing spatial queries to be run in SQL. The critical point using PostGIS is the absence of a dedicated API for any language. It requires to use a PostgreSQL adapter (such as psycopg for python) and to build dynamically the queries in the chosen language. Moreover the raster data support is still immature.

Quantum GIS Desktop, also known as QGIS, is an open-source GIS desktop application. QGIS supports both vector and raster formats. It has a module, PyQGIS, that supports scripting using the Python language. However, the functionalities implemented are more focused on spatial data visualization and do not give enough support for the analysis operations.

GDAL, Geospatial Data Abstraction Library, is an open-source library for geospatial data translation and processing. The related library OGR Simple Feature Library provides a similar capability for simple vector data processing. GDAL exposes API for C,C++ and Python while the more widely used API for OGR is the one for C++. OGR provides also slightly less complete API for C and Python, although they are not really well documented. The main issue using GDAL/OGR is the lack of support for the analysis of vector data: OGR offers useful API to read and write vector data, but analysis such as point linestring distance calculation are not available.

GRASS GIS, commonly referred to as GRASS (Geographic Resource Analysis Support System) is an open-source GIS software that gives support for geospatial data management and analysis. To understand how GRASS API works it is necessary to look at the GRASS software structure (see Fig.\ref{grass_structure}). GRASS has a large GIS library, referred to as GRASS GIS Library, at the basis of the software stack. It is divided in two main library: the Raster File Processing library and the Vector File Processing library. It contains also many others libraries of less importance. The GRASS GIS Library is quite large and implements many basic GIS operations both for raster and vector formats. The spatial data are stored in the GRASS map storage with the GRASS specific format. On the top of the GRASS GIS Library are built many modules for raster and vector processing. The modules perform analysis at a higher level, they are executables and can be used directly from the GRASS GUI or from the command line.

\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{images/grass6_arch.eps}
    \caption{(From http://grass.osgeo.org) GRASS software architecture.}\label{grass_structure}
  \end{center}
\end{figure}

GRASS allows two basic levels of programming. The first approach is to use script programming to call the high-level GRASS modules. A more advanced approach is to access the low-level functionalities trough the C-API exposed. Since grass modules are executables, the first approach requires to spawn a new process each time a spatial computation is needed. For the implementation of the model presented in chapter \ref{model} this is not feasible. Even if the second approach forces to use spatial operations at a lower lever it has many advantages: it gives support for database routines (GRASS file management), for projections, for raster and  vector data management and it guarantees good performances \cite{net2008}.

GRASS GIS was chosen to implement the GIS Backend. Since the API is written in ANSI C, writing the code in C or in C++ had the advantage of accessing the API in a very simple manner. Moreover both C and C++ guarantee good performances and are often chosen to implement this kind of simulation. C++ was preferred to C because having an object oriented design allows to better represent the models concepts, reducing the complexity, making the code structure clearer and keeping the code modular and flexible.

\section{Software structure}
The main entities modeled are the ski slope, the skiers and the forces that drive them. In Figure \ref{class_diagram} the software's class diagram is described:
\begin{enumerate}
\item Class Slope models the ski slope, it has a set of skiers, a set of physical forces that act on the slope and a set of social forces that skiers are subjected to.
\item Skier class models the skier's behavior: it has a position, a velocity, an acceleration and a status describing if they are turning.
\item Forces skiers are subjected to have been modeled using two different classes: SocialForce class and PhysicalForce class are abstract classes that act as base classes respectively for all the social forces and for all the physical forces. Although the interface declared by this two classes is the same, they were not merged together because the social and physical forces are conceptually different, making easier for future development of the model to change them using separated interfaces.
\end{enumerate}

\begin{figure}[!h]
  \begin{center}
    \includegraphics[width=\textwidth]{images/Class_diagram.eps}
    \caption{Class diagram.}\label{class_diagram}
  \end{center}
\end{figure}

The simulation has to perform some specific spatial computations. The implementation realized wanted to avoid dependencies between the code related to the simulation and the code written to implement GIS specific operations. In other words the implementation of the model should be independent by the technology chosen to implement the GIS Backend. For this reason, an abstract class called GisBackend was used. The class declares the interface that the GIS backend used to run the simulation must implement. This interface includes methods to get elevation, slope and aspect for given coordinates, methods to get the distance of a point from the edges of the slope, methods to give random starting points at the top of the ski slope, to determine if a given point is inside the ski slope and a method to reflect a line colliding on a slope edge.

The class GrassBackend implements the interface GisBackend and is the class used in the code when spatial computations are needed. The class GrassBackend uses the GRASS GIS Library. It checks to have available a DEM (Digital Elevation Model) raster map for the elevation, the slope and the aspect computation, a polygon vector map describing the ski slope to determine if a position is inside the slope, a line vector map describing the right and the left edges of the slope to find the distances from them and finally a vector map with the polygons of the start and stop areas to decide where skiers should be started and stopped.

\section{Input data}
The input data required by the simulation to run are the data needed by the GrassBackend. It requires the vector map with the polygon of the ski slope for which the model should be run. The ski slope (see Fig.\ref{uno_tognola_3d} for an example) is extracted from a vector map containing all polygons of the ski slopes of Trentino's ski resort. This data come from the SicurSkiWeb database and were derived starting from orthophotos and adjusted with field measurements. From the polygon of the ski slope the left and right edges, the start and stop areas are derived.

\begin{figure}[!h]
  \begin{center}
    \includegraphics[width=\textwidth]{images/uno_tognola_3d.eps}
    \caption{3d visualization of the ski slope ``Uno di Tognola'' polygon (in blue) in San Martino di Castrozza.}\label{uno_tognola_3d}
  \end{center}
\end{figure}

As second set of inputs, the simulation model requires some features extracted from a Digital Elevation Model. In this case the Digital Terrain Model (DTM) of the Autonomous Province of Trento was used. The DTM was computed using the LIDAR flight data of 2006 and 2007, it has a spatial resolution that variates between 1 meters and 2 meters, depending on the location.

The measurements for the DTM were taken during the summers season without the presence of snow. As a consequence the surface on which real skiers move is different from the DTM obtained from the Lidar data.

Two strategies were thought to simulate the effect of the snow:
\begin{enumerate}
\item A simple model was implemented to simulate the distribution of the snow. The model considers two limit cases to describe the profile of the snow. Given a surface $y(x)$ and a snowfall of $h$ meters, the first case describes a new profile were the snow is supposed to adhere perfectly to the terrain: $y_S(x)=y(x)+h$. The second case considers the snow to behave like a liquid and creates a new profile $y_L(x)$ where precipitations accumulate in the valleys, making the profile constant, and leaves $y_L(x)=y(x)$ on the ridges. Neither the first nor the second case can be considered realistic, however it can be thought that the real behavior of the snow can be described as an average between the two cases. The actual profile after the precipitation can be described as
\begin{equation}
Y(x)=(1-l)y_S(x)+ly_L,
\end{equation}
where $l$ is a parameter describing how much snow has a liquid-like behavior. From the point of view of the implementation, the critical factor is the computation of the profile $y_L$. For this purpose some GRASS modules were explored: r.watershed, r.terraflow, r.sim.water. The first two were excluded as they compute the flow accumulation rather than the water accumulation. The third module, r.sim.water, is an overland flow hydrologic simulation based on path sampling method \cite{mit2004}, used to compute the profile $y_L$.
\item The second strategy  starts from the consideration that there are three main factors determining the distribution of the snow on a ski slope: the snow precipitation, the snow produced by the snow cannons and the actions of the snow groomings. All this factors tend to smooth the original surface. To emulate this action the surface of the DTM was approximated with a smoothed surface. Starting from the original DTM raster map a vector map was produced where each original value of elevation was represented by a point. Then the GRASS module v.surf.rst was used to interpolate these points into a new elevation map using regularized spline with tension \cite{mit2005}.
\end{enumerate}

\begin{figure}[!th]
  \centering
    \includegraphics[width=0.8\textwidth]{images/profiles_dtm.eps}
    \caption{Profiles of the DTM compared to profile of the DTM smoothed and of the DTM covered with simulated snow.}\label{profile_dtm}
\end{figure}

Figure \ref{profile_dtm} compares the profiles of the original dtm, of the dtm obtained from the first strategy and of the one obtained from the second strategy for a particularly critical point on a ski slope. Following the first strategy, the results of the module r.sim.water did not return a feasible profile for a liquid-like behavior. This can be linked to a misconfiguration of the module parameters or to very high level of precision demanded. The best result was given by the second strategy, that was chosen for this purpose.

Starting from the smoothed DTM, slope and aspect raster maps were computed using the GRASS module r.slope.aspect. The slope map contains the slope of every single raster cell, defined as the degrees of inclination from the horizontal. The slope of a cell is the maximum rate of change in height from that cell to its neighbors. Conceptually, computing the slope is equivalent to fits a plane to the z-value of a 3x3 neighborhood around the center cell. The slope value of this plane is computed using the average maximum technique \cite{bur2009}. The orientation of the maximum slope direction toward the east defines the aspect.

\section{Output data}\label{output_data}
The output produced by the simulation model is the status (position and speed) of each skier at each integration step of the simulation. The information logged at a time $t$ for a skier $a$ are the position $r_a$ and the velocity $\dot{r}_a$.

\begin{figure}
        \centering
        \begin{subfigure}[b]{\textwidth}
                \centering
                \includegraphics[width=\textwidth]{images/rod_velocity_map.eps}
                \caption{}\label{rododendro_vel}
        \end{subfigure}%

        %~ add desired spacing between images, e. g. ~, \quad, \qquad etc.
          %(or a blank line to force the subfigure onto a new line)
        \begin{subfigure}[b]{\textwidth}
                \centering
                \includegraphics[width=\textwidth]{images/rod_density_map.eps}
                \caption{}\label{rododendro_den}
        \end{subfigure}
        \caption{Average simulated speed map (a) and skiers density map (b) for the ski slope ``Rododendro''.}\label{rododendro}
\end{figure}

Starting from this data the skiers speed average and the skiers density on the considered ski slopes were computed. Interpolating the speed values obtained by the simulation a raster map of the skiers speed is obtained (see Fig.\ref{uno_tognola_vel} and Fig.\ref{rododendro_vel}). This map can be then used to analyze the skiers speed on every location of the ski slope surface. The interpolation was done using the GRASS module v.surf.idw. The GRASS module v.kernel was used to compute the density of skiers on the slope. The raster density map is computed using a moving kernel with gaussian distribution (see Fig.\ref{uno_tognola_den} and Fig.\ref{rododendro_den}).

\begin{figure}
        \centering
        \begin{subfigure}[b]{\textwidth}
                \centering
                \includegraphics[width=\textwidth]{images/sm_velocity_map.eps}
                \caption{}\label{uno_tognola_vel}
        \end{subfigure}%

        %~ add desired spacing between images, e. g. ~, \quad, \qquad etc.
          %(or a blank line to force the subfigure onto a new line)
        \begin{subfigure}[b]{\textwidth}
                \centering
                \includegraphics[width=\textwidth]{images/sm_density_map.eps}
                \caption{}\label{uno_tognola_den}
        \end{subfigure}
        \caption{Average simulated speed map (a) and skiers density map (b) for the ski slope ``Uno di Tognola''.}\label{uno_tognola}
\end{figure}

\section{Parameters Selection}
The parameters of the model are of three types: parameters describing the ski slope, parameters regulating the social forces and parameters for the physical forces.

The model assumes that skiers arrive at the beginning of ski slopes at a constant rate. Let $\lambda$ be the persons per hour descending a ski slope, then the time between the start of two consecutive skiers is $T=\mathcal{U}\left(2\frac{3600}{\lambda}\right)$, where $\mathcal{U}(a)$ is the uniform distribution between $0$ and $a$. For the ski slope ``Uno di Tognola'' an arrival rate of $\lambda=200$~persons/h was chosen.

As in \cite{hol2012} and in \cite{hel2008}, the repulsive potentials defining the social forces are exponential and defined as
\begin{align}
U(\norm{r_{aL}})&=U_0 \exp(-\norm{r_{aL}}/R_L), \\
U(\norm{r_{aR}})&=U_0 \exp(-\norm{r_{aR}}/R_R), \\
V(s)&=V_0 \exp(-s/R_A),
\end{align}
where $R_L$, $R_R$ and $R_A$ describe the ranges of the social repulsions, and $U_0$ and $V_0$ are scaling constants that regulate the interaction strength between skiers and the respective object.

The parameters regulating the social forces were set to have forces with equivalent strength and realistic interaction. For the destination force was set $A_0=1$, for the repulsion forces $U_0=10$, $V_0=8$, $R_L=R_R=10$ and $R_A=8$. These choices have the practical implications that the magnitude of the destination force is always equals to $1$ and the repulsion forces tend to $1$ when the skier approximates the edges or other skiers. For non-experienced skiers the strength and the range of edge repulsion can be increased to model their attitude to keep a higher distance from edges than experienced skiers.

 The angle of view is set to $2\varphi=180\degree$. As presented in chapter \ref{model}, skiers adjust their direction performing turns when the angle between their direction of motion and the desired direction exceed the angle $\delta$ (see Fig.\ref{start_turn_pic}). This angle was set to $\delta=10\degree$. The values selected for the social parameters are summarized in Table \ref{social_parameters_table}.

\begin{table}[!h]
  \centering
  \begin{tabular}{ | l | c | c | }
    \hline
    Parameter & Symbol & Value \\
    \hline
    Strength of destination force & $A_0$ & 1 \\
    Strength of edge repulsion & $U_0$ & 10 \\
    Strength of athlete repulsion & $V_0$ & 8 \\
    Range of edge repulsion & $R_L=R_R$ & 10 \\
    Range of athlete repulsion & $R_A$ & 8 \\
    Angle of view & $2\varphi$ & $180\degree$ \\
    Directional deviation & $\delta$ & $10\degree$ \\
    \hline
  \end{tabular}
  \caption{Summary table for parameters regulating social forces.}
  \label{social_parameters_table}
\end{table}

The initialization of the parameters regulating the physical forces was based on values known from the literature. The main reference for choosing the values of the parameters was \cite{hol2012}. The density of air was set to $\rho_{air}=1.3163 $~Kg/m$^{3}$, the mass of the skiers, including clothes and equipment, to $m=85 $~Kg. The gravitational acceleration was taken equals to $g=9.81 $~m/s. The sidecut radius of the skis was set to $R_{SC}=10 $~m for expert skiers. This values was increased simulating non-experienced skiers, that usually need more space to complete the turns. According to the values suggested in \cite{bu2004}, the kinetic friction coefficient was set to $\mu = 0.05$. The air drag coefficient $C_d = 1.0$ was chosen and the frontal area was set to $A=0.6 $~m$^2$. These values are summarized in Table \ref{physical_parameters_table}.

\begin{table}[!h]
  \centering
  \begin{tabular}{ | l | c | c |}
    \hline
    Parameter & Symbol & Value \\
    \hline
    Air density & $\rho_{air}$ & $1.3163 $Kg/m$^{3}$ \\
    Skier mass & $m$ & $85 $Kg \\
    Gravitational acceleration & $g$ & $9.81 $m/s$^2$ \\
    Sidecut radius & $R_{SC}$ & $10$m \\
    Kinetic friction coefficient & $\mu$ & $0.05$ \\
    Air drag coefficient & $C_d$ & $1.0$ \\
    Frontal area & $A$ & $0.6 $m$^2$ \\
    \hline
  \end{tabular}
  \caption{Summary table for parameters regulating physical forces.}
  \label{physical_parameters_table}
\end{table}

\section{Optimization}
An analysis of the performances of the software was performed in order to improve the computation time. The sections of the software more critical were those sections accessing the files containing the spatial data. These operations, performed by the GrassBackend, were needed to access the data saved in the GRASS map storage and are very time consuming. To speed up the calls to the GrassBackend a caching mechanism was implemented. For the queries requesting raster map values, once a cell value has been fetched it is cached in memory, so that the next queries will access the data quicker. The implementation of the cache was done using the map class available inside the C++ standard library. The map class is an implementation of an associative containers that was used to efficiently store and retrieve values (the raster map values) using keys (the combination of rows and columns). The speed-up reached thanks to the caching mechanism can be seen in Figure \ref{speed-up_cache}.

\begin{figure}[!h]
  \begin{center}
    \includegraphics[width=\textwidth]{images/caching.eps}
    \caption{Computation time comparison between simulations with cache and simulations without it.}\label{speed-up_cache}
  \end{center}
\end{figure}

\chapter{Steps to validate the model}\label{steps_validate}
\section{Field data sampling}
The mobile application SkiLogger was used to collect real data describing the skiers trajectories. SkiLogger is an Android application developed within the SicurSkiWeb project by the MPBA unit of the Bruno Kessler Foundation. It allows the skiers to track their position using GPS technology while skiing and to monitor skiers trajectories and paths.

SkiLogger was released for beta testing starting from February 2013. At this moment the application does not offer any additional functionality, but for the next seasons it is planned to implement new features such as real time information reports about ski slope conditions and traffic, routing trough the ski slopes network and other skiers position tracking. The goal is to incentive more skiers to use SkiLogger, collecting a large dataset of real data.

The data collected by the application needs to be filtered: the gps does not always give an accurate position and the application logs every moment including when using ski lifts. Automated procedures have been developed to individuate and filter the single downhill tracks. As a first elaboration the speed at each point recorded has been computed. In order to minimize the effects of oscillations in the gps measurements, for the recorded position $x_i$ at the time $t_i$, the speed was computed considering the previous and following positions as follow
\begin{equation}
v_i=\frac{\norm{x_i-x_{i-1}}+\norm{x_{i+1}-x_i}}{t_{i+1}-t_{i-1}}.
\end{equation}

The second step preprocessing the data is to filter the positions tracked when skiers are on ski lifts. For this purpose, a sliding window that considers sequences of ten points at a time was used. A sequence of points is considered valid if the slope between the first and the last point is downhill and it is greater than a minimum threshold or if the skier keeps a speed greater than a fixed minimum speed. The idea is to exclude sequences of points tracking movements in flat areas or moving uphill, avoiding at the same time to eliminate those sequences tracking movements in area of ski slopes that are counter slope where skiers should usually keep a minimum speed to avoid stopping.

\begin{figure}[!b]
  \begin{center}
    \includegraphics[width=\textwidth]{images/data_tognola.eps}
    \caption{Real skiers data logged with the mobile application SkiLogger on the ski slope ``Uno di Tognola'' in San Martino di Castrozza.}\label{data_tognola}
  \end{center}
\end{figure}

Finally, the last step preprocessing the data is to isolate the single downhill tracks. This is done in two steps, first the starts of the tracks are individuated, then each point is assigned to the right track (if any exists):
\begin{enumerate}
\item The start of a track is defined as a sequence of at least forty points of the same skier, that are logged within a temporal range and that cover more than a fixed minimum distance. This step is taken to eliminate the noise produced by the gps when skiers stop. In fact, when a skier does not move, the gps tends to jump from different positions generating false movement. This is particularly true when the gps does not have a good signal.
\item Once the start of a track is found all the following sequences of forty points that are within a time range and that represent a downhill movement are considered to be part of this start track. This last step individuates the single tracks and eliminates the points that are noise due to the inaccuracy of the gps.
\end{enumerate}

Figure \ref{data_tognola} shows an example of the data recorded with the tracks highlighted. In some sections of the slope gps inaccuracies can be noticed. Sometimes discrepancies can also be due to inaccuracies in the trail of the ski slope.

For the season 2012/2013 a total of 178502 meters of descent has been tracked divided in 115 separated tracks. The average length of a track is of 1552 meters. 100 tracks are longer than 500 meters (Table \ref{descendts}).

\begin{table}[!h]
  \centering
  \begin{tabular}{ | l | c | }
    \hline
    Total number of tracks & 115 \\ \hline
    Total meters tracked & 178502m \\ \hline
    Average length for track & 1552m \\ \hline
    Tracks longer than 500m & 100 \\
    \hline
  \end{tabular}
  \caption{Summary table for tracks data logged.}
  \label{descendts}
\end{table}

The total number of skiers that has used the application is 18. Each skier was asked to provide some information before starting to use the application. These information were a self-assessment of the skiing skill, the kind of tool used (skis, snowboard, telemark...), the dimension of the group and the age class of the skier. Only two skiers chose the beginner level and tracked 6 tracks for a total of 906 meters. Three skiers were intermediate, with 6 tracks and 6264 meters tracked. Thirteen skiers were experts, they logged 103 tracks and 171331 meters (Table \ref{skiers}).

\begin{table}[!h]
  \centering
  \begin{tabular}{ | c | c | c | c | }
    \hline
    Level & Skiers number & Tracks & Total meters \\
    \hline
    Beginner & 2  & 6 & 906m \\
    Intermediate & 3 & 6 & 6264m \\
    Expert & 13 & 103 & 171331m \\
    \hline
  \end{tabular}
  \caption{Summary table for skiers that used SkiLogger.}
  \label{skiers}
\end{table}

The main issue with the data collected is that they are not statistically relevant. Of the total 115 tracks, 52 were tracked by one skier. Another problem is that they are spread on ten different skiing resorts in Trentino. For this reason we have very few ski slopes that were tracked by different skiers. In particular there are only two slopes with 5 or 4 different skiers, 8 slopes with 3 skiers and 62 slopes with 1 or 2 skiers (Table \ref{slopes}).

\begin{table}[!h]
  \centering
  \begin{tabular}{ | c | c | }
    \hline
    Different skiers & Slopes number \\
    \hline
    5 & 1 \\
    4 & 1 \\
    3 & 8 \\
    2 & 18 \\
    1 & 44 \\
    \hline
  \end{tabular}
  \caption{Table summarizing the number of different skiers for the ski slopes.}
  \label{slopes}
\end{table}

The data collected does not allow a robust tuning of the parameters and to validate the model for ski slopes in Trentino. However an initial test of the data simulated by the model has been performed using the data collected.

\section{Simulated vs. real data}
\begin{figure}[!h]
  \centering
    \includegraphics[width=0.8\textwidth]{images/traiettorie.eps}
    \caption{Simulated and recorded trajectories on the ski slope ``Uno di Tognola''.}\label{traj}
\end{figure}

This part of the analysis focuses on the difference between the speed estimated by the simulation and the speed recorded by the SkiLogger application. The data collected were to few to analyze the map of skiers density produced. Starting from the map of simulated speed (see Fig.\ref{uno_tognola_vel}), produced as described in section \ref{output_data}, the values of speed computed for each point tracked by the application were compared to the values of speed of the map. Figure \ref{sm_track47} shows the comparison between real and simulated values of speed for the track 47 of the skier 15 recorded on the ski slope ``Uno di Tognola'': while simulated skiers do not stop during the descent the real skier stopped at least three times. The average error for the tracks considered ranges between 4.28 m/s and 6.44 m/s, while recorded speeds range from 0 to 30 m/s.

\begin{figure}
  \begin{center}
    \includegraphics[width=0.7\textwidth]{images/sm_track47.eps}
    \caption{Comparison between simulated and real speed for the track 47 on the ski slope ``Uno di Tognola''.}\label{sm_track47}
  \end{center}
\end{figure}

To investigate the relation between simulated and real speeds, the spatial distribution of the error between them was considered. For each track recorded on the ski slope, the error between real and simulated values was computed as $e=v_R-v_S$, where $v_R$ is the real speed recorded and $v_S$ the speed simulated by the model. Figure \ref{map_error} shows the map of the error made for each point of the tracks. The points in the map where the speed error is higher are where skiers stopped. It can be seen that the error produced by stops reverberates on the path sections following them.

\begin{figure}[!h]
  \centering
    \includegraphics[width=\textwidth]{images/map_error.eps}
    \caption{Map of the errors between the real and the simulated speed for the tracks recorded on the ski slope ``Uno di Tognola''.}\label{map_error}
\end{figure}

To compare the speed values without the additional error due to stops, a new simulation was run where the simulated skiers were forced to stop according to the stops made by the skier 35 in the track 116. A new map of simulated speed was interpolated, Figure \ref{sm_stops_track116} shows the new comparison for the track 116. In the first part of the track the simulation shows a good correspondence with the real data. In the last two runs the simulation overestimates the speed. Overall, the average error decreased from 5.56 m/s to 2.52 m/s.

\begin{figure}[!h]
        \centering
        \begin{subfigure}[b]{0.5\textwidth}
                \centering
                \includegraphics[width=\textwidth]{images/sm_track116.eps}
                \caption{}
                \label{Sno_stops}
        \end{subfigure}%
        ~ %add desired spacing between images, e. g. ~, \quad, \qquad etc.
          %(or a blank line to force the subfigure onto a new line)
        \begin{subfigure}[b]{0.5\textwidth}
                \centering
                \includegraphics[width=\textwidth]{images/sm_stops_track116.eps}
                \caption{}
                \label{Sstops}
        \end{subfigure}
        \caption{Simulated and real speed values for track 116 of ``Uno di Tognola''. Figure \ref{Sno_stops} is without stops, in Figure \ref{Sstops} simulated skiers were forced to stop as the real skier.}\label{sm_stops_track116}
\end{figure}

\section{Simulated ski lessons}\label{ski_lessons}
In the data collected there were two recorded tracks related to a ski lessons. To make the model simulating this kind of situations an adaptation was realized. There are many kind of ski lessons. The first distinction is between individual and group lessons. In group lessons instructors usually choose the trajectory and are followed by the skiers that try to emulate their movement; alternatively the instructor performs some turns, stops and observes the skiers performing the turns one at a time. The ski lessons simulation focused on the group lessons in the case that skiers involved in the lesson form a queue behind the instructor.

\begin{figure}[!b]
  \centering
    \includegraphics[width=0.8\textwidth]{images/lesson.eps}
    \caption{Trajectories of a simulated ski lesson on the ski slope ``Rododendro'' of San Martino di Catrozza. The red line is the instructor trajectory.}\label{lesson}
\end{figure}

The instructor was simulated as an expert skier, the skidding factor was set to $\eta=0$ and the parameter ${v_{high}}$ was kept low to force them making more turns. Additionally the time between the choice of two consecutive waypoints is higher than usual and also the turning radius is increased.

The other skiers were modeled as non-experienced skiers, with the skidding factor $\eta$ assuming different values. These skiers have forced waypoints. Precisely, each time the instructor begins a turn a waypoint is set in this position for all the skiers. In this way each skier tries to reach each waypoint fixed by the instructor being at the same time subjected to the other social forces such as the repulsion from the other skiers. If a waypoint becomes unreachable the skier passes to the following one. In the case that at a certain time no waypoints are available, the waypoint is set to the instructor position. To avoid being to distance from the other skiers the instructor reduces their speed according to the distance between the nearest skier and the farthest one. Figure \ref{lesson} shows the simulated trajectories for a ski lesson.

\chapter{Conclusions and future work}\label{conclusions}
A particle-based model to simulate the riding behavior of skiers descending ski slopes was implemented. The model was originally proposed by Holleczek and Troster \cite{hol2012}, the following new features were introduced:
\begin{itemize}
\item Non-experienced skiers were included in the model. By calibrating a newly introduced parameter, the skidding parameter $\eta$, intermediate and beginner skiers can be simulated.
\item The waypoints selection has been made dynamical, the new strategy implemented allows each skier to choose waypoints during the descent, based on their position, the shape of the trail, the slope of the terrain and the skier speed.
\end{itemize}
Additionally an adaptation of the model has been implemented to simulate ski lessons. In these simulations a variable number of skiers follow the instructor trying to reproduce his or her trajectory.

An Open Source GRASS module has been released. This module implements the model described using C++ and the GRASS GIS Library. The module is an executable that can be run in a GRASS environment. The code can be found at \url{http://github.com/pollo/skiing_traffic}.

The simulations were used to compute indicators about the skiing traffic on the slopes. In particular, the average speed and density of skiers have been investigated. Two raster maps were produced: one reporting the average speed of the simulated skiers for each pixel of the map and another one indicating the density of the skiers in every location of the ski slope.

The model has been tested on real data collected by the mobile application SkiLogger. For the ski slope ``Uno di Tognola'' in San Martino di Castrozza, 8 recorded tracks were available. A comparison between the simulated and the recorded speed showed an average error for single track that ranged between 4.28 m/s and 6.44 m/s, while recorded speeds ranged from 0 to 30 m/s. By introducing a new parameter that forced simulated skiers to stop in some predetermined areas, the average error for a specific track was decreased from 5.56 m/s to 2.52 m/s.

For the next ski season a new version of the SkiLogger application will be released offering new features to the skiers. Once a critical mass of data will be collected, a complete calibration and validation of the model for the Trentino ski slopes will be made. Moreover, the possibility of collecting more empirical data exploiting the potential of wearable-sensors will be investigated.

In future developments the repulsion from obstacles will be included in the simulation, by acquiring information about the physical obstacles on the ski slopes. Moreover, depending on the skiers ability, some areas of the ski slopes will be considered obstacles to make the skiers avoid trajectories perceived as dangerous (for example sheets of ice or high slope areas).

So far, there are no studies validating the prediction of skiers density on the ski slope made by this kind of simulation. If a large amount of data will be recorded in the next season, a validation of this part of the model will be performed. Alternatively, a different approach can be followed using video records of some selected ski slopes from which computer vision algorithms can extract the skiers trajectories \cite{sc2010}.

To predict in a more precise way the skiers density, new aspects related to the skiers behavior will be investigated. So far, the model does not differentiate between different skiers attitudes. While riding downhill, the skiers choice of the trajectory is influenced by the perceptions they get from the environment. These are not limited to other skiers and edges repulsion but also deal with the personal attitude of the skier. For example a cautious skier will predict more carefully the possible trajectories of other skiers, will examine the condition of the slope and of the snow to choose the less risky trajectory possible. On the other hand, a more daring skier will choose a more challenging trajectory that gives him the possibility to test his skills. Lastly the behavior and the dynamics of skiers moving in groups will be explored. In the future, the collection of more empirical data will enable the investigation of the foundations of these conjectures.

\bibliography{thesis}

\appendix
\chapter{Simulations summary values varying parameters}
\markright{John Smith\hfill On page styles\hfill}
\begin{table}[h]
  \centering
  \begin{tabular}{ | c | c | c | c | }
    \hline
    Kinetic Friction & Travel time & Average speed & Maximum speed \\
    \hline
    0.05 & 166s & 17.31m/s & 23.23m/s \\
    \hline
    0.06 & 176s & 16.38m/s & 23.08m/s \\
    \hline
    0.07 & 194s & 14.82m/s & 22.45m/s \\
    \hline
    0.08 & 210s & 13.63m/s & 22.08m/s \\
    \hline
    0.09 & 224s & 12.78m/s & 20.59m/s \\
    \hline
    0.10 & 238s & 12.04m/s & 20.14m/s \\
    \hline
    0.11 & 247s & 11.60m/s & 20.32m/s \\
    \hline
    0.12 & 259s & 11.04m/s & 19.94m/s \\
    \hline
  \end{tabular}
  \caption{Average travel time, average skiers speed and maximum skiers speed values simulating 20 skiers on the ski slope ``Uno di Tognola'' for different values of kinetic friction coefficient.}
\end{table}
\begin{table}
  \centering
  \begin{tabular}{ | c | c | c | c | }
    \hline
    ${v_{high}}$ parameter & Travel time & Average speed & Maximum speed \\
    \hline
    25m/s & 237s & 12.12m/s & 20.97m/s \\
    \hline
    20m/s & 240s & 12.01m/s & 20.44m/s \\
    \hline
    15m/s & 242s & 11.97m/s & 20.44m/s \\
    \hline
    10m/s & 244s & 11.85m/s & 20.30m/s \\
    \hline
  \end{tabular}
  \caption{Average travel time, average skiers speed and maximum skiers speed values simulating 20 skiers on the ski slope ``Uno di Tognola'' for different values of the ${v_{high}}$ parameter.}
\end{table}
\newpage
\thispagestyle{plain}
\begin{table}[!t]
  \centering
  \begin{tabular}{ | c | c | c | c | }
    \hline
    Mass & Travel time & Average speed & Maximum speed \\
    \hline
    110Kg & 222s & 13.01m/s & 21.47m/s \\
    \hline
    100Kg & 229s & 12.56m/s & 21.31m/s \\
    \hline
    90Kg & 236s & 12.17m/s & 20.54m/s \\
    \hline
    80Kg & 243s & 11.87m/s & 20.15m/s \\
    \hline
    70Kg & 252s & 11.42m/s & 19.16m/s \\
    \hline
    60Kg & 264s & 10.87m/s & 18.62m/s \\
    \hline
  \end{tabular}
  \caption{Average travel time, average skiers speed and maximum skiers speed values simulating 20 skiers on the ski slope ``Uno di Tognola'' for different values of skiers mass.}
\end{table}
\begin{table}[!h]
  \centering
  \begin{tabular}{ | c | c | c | }
    \hline
    Travel time & Average speed & Maximum speed \\
    \hline
    248s & 11.61m/s & 19.63m/s \\
    \hline
  \end{tabular}
  \caption{Average travel time, average skiers speed and maximum skiers speed values simulating adolescents skiers on the ski slope ``Uno di Tognola''. Mass was set to 50Kg and the frontal area $A$ to $0.4 m^2$.}
\end{table}

\end{document}